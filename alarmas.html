<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planificador de Tiempo</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Font Awesome para los iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@300&display=swap">
  <style>

    .content-section {
      max-width: 100%;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background-color: #ffffff;
      table-layout: auto;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      word-wrap: break-word;
      position: relative;
    }

    table th {
      background-color: #e9ecef;
      font-size: 1.2em;
      font-weight: bold;
    }

    .editable {
      background-color: #ffffe0;
      cursor: pointer;
    }

    .delete-btn {
      background-color: transparent;
      color: #ff5c5c;
      border: none;
      padding: 10px;
      cursor: pointer;
      transition: color 0.3s, transform 0.3s;
      font-size: 1.2em;
      margin-right: 8px;
    }

    .delete-btn:hover {
      color: #e04e4e;
      transform: scale(1.2);
    }

    .activity-cell {
      position: relative;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .add-btn-inline {
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.05);
      color: #4CAF50;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5em;
      line-height: 30px;
      text-align: center;
      opacity: 0.7;
      transition: background-color 0.3s, opacity 0.3s;
    }

    .add-btn-inline:hover {
      background-color: rgba(0, 0, 0, 0.1);
      opacity: 1;
    }

    .form-group {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
    }
    .controles-archivo {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    #fecha-google-calendar {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      margin-top: 10px;
    }

    .controles-modal {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .boton-secundario {
      background-color: #6c757d;
    }

    .boton-secundario:hover {
      background-color: #5a6268;
    }


    /* Modal styles for help section */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
    }

    .modal-content h3 {
      text-align: center;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
    }

    @media (max-width: 768px) {
      header {
        padding: 10px;
      }

      input[type="number"] {
        width: 50px;
      }

      h1 {
        font-size: 2em;
      }

      table th, table td {
        font-size: 0.8em;
        padding: 6px;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .content-section {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="header-content">
      <h1>Planificador de Tiempo</h1>
      <nav class="nav-links">
        <a href="index.html">Volver</a>
      </nav>
    </div>
    <a href="#planner" class="scroll-down" aria-label="Desplazar hacia el contenido">
      <i class="fas fa-chevron-down"></i>
    </a>
  </header>

  <main>
    <section id="planner" class="content-section">
      <h2>Configuración de Actividades <button id="help-button" class="button small">?</button></h2>
        <div class="controles-archivo">
          <button id="boton-exportar" class="button small">Exportar</button>
          <button id="boton-exportar-google" class="button small">Exportar a Google Calendar</button>
          <button id="boton-importar" class="button small">Importar</button>
          <input type="file" id="archivo-importar" accept="application/json" style="display:none">
          <button id="boton-reiniciar" class="button small">Reiniciar</button>
        </div>


      <div style="overflow-x: auto;">
        <table id="activity-table">
          <thead>
            <tr>
              <th>Actividad</th>
              <th>Inicio</th>
              <th>Duración (min)</th>
            </tr>
          </thead>
          <tbody>
              <tr class="fixed">
                <td>Hora de inicio
                <button class="add-btn-inline">+</button></td>
                <td><input type="time" id="start-time"></td>
                <td>-</td>
              </tr>
              <tr class="fixed">
                <td>Hora de fin</td>
                <td><input type="time" id="end-time" ></td>
                <td>-</td>
              </tr>
          </tbody>
        </table>
      </div>
      <div class="form-group">
        <label for="total-duration">Duración total:</label>
        <span id="total-duration">00:00</span>
      </div>
    </section>

    <!-- Modal with help content -->
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <span id="close-help" class="close">&times;</span>
        <h3>¿Cómo usar?</h3>
        <p style="text-align: justify; font-size: 1em; line-height: 1.5;">
          Esta herramienta está pensada para maximizar tus horas de sueño y organizar tus mañanas de forma eficiente. Seleccioná las actividades que hacés habitualmente por la mañana y asignales el tiempo (aproximado) que te llevan, como se ve en los ejemplos. Podés agregar nuevas actividades, o eliminar las existentes tocando el ícono del tachito. Luego, configurá la hora a la que querés terminar todo, y automáticamente se calculará la hora de inicio. Esto te va a ayudar a saber a qué hora programar tus alarmas para optimizar tu descanso. También podés fijar la hora de inicio y la herramienta calculará a qué hora vas a terminar con todo.
        </p>
      </div>
    </div>

    <div id="modal-google-calendar" class="modal">
      <div class="modal-content">
        <span id="cerrar-modal-google" class="close">&times;</span>
        <h3>Exportar a Google Calendar</h3>
        <p style="text-align: justify; font-size: 1em; line-height: 1.5;">
          Elegí el día al que querés aplicar estas actividades. Te proponemos la fecha de hoy, salvo que ya sea de noche, en cuyo caso sugerimos mañana.
        </p>
        <input type="date" id="fecha-google-calendar">
        <div class="controles-modal">
          <button id="cancelar-exportacion-google" class="button small boton-secundario">Cancelar</button>
          <button id="confirmar-exportacion-google" class="button small">Exportar</button>
        </div>
      </div>
    </div>
  </main>

    <script>
      $(document).ready(function () {
        const $horaInicioInput = $('#start-time');
        const $horaFinInput = $('#end-time');
        const $duracionTotalEtiqueta = $('#total-duration');
        const $tablaActividades = $('#activity-table tbody');
        const $modalAyuda = $('#help-modal');
        const $botonAyuda = $('#help-button');
        const $cerrarAyuda = $('#close-help');
        const $botonExportar = $('#boton-exportar');
        const $botonExportarGoogle = $('#boton-exportar-google');
        const $botonImportar = $('#boton-importar');
        const $archivoImportar = $('#archivo-importar');
        const $botonReiniciar = $('#boton-reiniciar');
        const $modalGoogle = $('#modal-google-calendar');
        const $cerrarModalGoogle = $('#cerrar-modal-google');
        const $fechaGoogle = $('#fecha-google-calendar');
        const $confirmarExportacionGoogle = $('#confirmar-exportacion-google');
        const $cancelarExportacionGoogle = $('#cancelar-exportacion-google');

        $botonAyuda.on('click', function () {
          $modalAyuda.fadeIn();
        });

        $cerrarAyuda.on('click', function () {
          $modalAyuda.fadeOut();
        });

        $(window).on('click', function (e) {
          if ($(e.target).is($modalAyuda)) {
            $modalAyuda.fadeOut();
          }
          if ($(e.target).is($modalGoogle)) {
            cerrarModalGoogleCalendar();
          }
        });

        function guardarEnLocal() {
          const actividades = [];
          $tablaActividades.find('tr').not('.fixed').each(function () {
            const nombre = $(this).find('.activity-name').text();
            const minutos = parseInt($(this).find('input[type="number"]').val(), 10) || 0;
            actividades.push({ nombre, minutos });
          });
          localStorage.setItem('actividades', JSON.stringify(actividades));
          localStorage.setItem('horaInicio', $horaInicioInput.val());
          localStorage.setItem('horaFin', $horaFinInput.val());
        }

        function cargarDesdeLocal() {
          const guardado = localStorage.getItem('actividades');
          if (guardado) {
            return JSON.parse(guardado);
          }
          const ejemplo = [
            { nombre: 'Alarma', minutos: 2 },
            { nombre: 'Bañarse', minutos: 30 },
            { nombre: 'Cambiarse', minutos: 15 },
            { nombre: 'Viaje', minutos: 30 }
          ];
          localStorage.setItem('actividades', JSON.stringify(ejemplo));
          localStorage.setItem('horaInicio', '07:00');
          localStorage.setItem('horaFin', '08:17');
          return ejemplo;
        }

        function renderizarActividades(lista) {
          const $filaFin = $tablaActividades.find('tr').last();
          lista.forEach(act => {
            const fila = `
            <tr class="activity-row">
              <td class="activity-cell">
                <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                <div contenteditable="true" class="activity-name editable">${act.nombre}</div>
                <button class="add-btn-inline">+</button>
              </td>
              <td></td>
              <td><input type="number" value="${act.minutos}"></td>
            </tr>`;
            $filaFin.before(fila);
          });
        }

        function establecerTiemposIniciales() {
          const inicioGuardado = localStorage.getItem('horaInicio') || '07:00';
          const finGuardado = localStorage.getItem('horaFin') || '08:17';
          $horaInicioInput.val(inicioGuardado);
          $horaFinInput.val(finGuardado);
          calcularInicioDesdeFin();
        }

        function calcularDuracionTotal() {
          let minutosTotales = 0;
          $tablaActividades.find('tr').not('.fixed').find('input[type="number"]').each(function () {
            const valor = parseInt($(this).val(), 10);
            if (!isNaN(valor)) {
              minutosTotales += valor;
            }
          });
          const horas = Math.floor(minutosTotales / 60);
          const minutos = minutosTotales % 60;
          $duracionTotalEtiqueta.text(`${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`);
          return minutosTotales;
        }

        function calcularHorariosDesdeInicio() {
          const inicio = $horaInicioInput.val().split(':');
          let hora = parseInt(inicio[0], 10);
          let minuto = parseInt(inicio[1], 10);
          let horaActual = new Date(0, 0, 0, hora, minuto, 0);

          $tablaActividades.find('tr').not('.fixed').each(function () {
            const $inicioActividad = $(this).find('td').eq(1);
            const duracion = parseInt($(this).find('input[type="number"]').val(), 10);
            if (!isNaN(duracion)) {
              $inicioActividad.text(horaActual.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
              horaActual.setMinutes(horaActual.getMinutes() + duracion);
            } else {
              $inicioActividad.text('NaN');
            }
          });

          $horaFinInput.val(horaActual.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
        }

        function calcularInicioDesdeFin() {
          const fin = $horaFinInput.val().split(':');
          let hora = parseInt(fin[0], 10);
          let minuto = parseInt(fin[1], 10);
          let fechaFin = new Date(0, 0, 0, hora, minuto, 0);

          const minutosTotales = calcularDuracionTotal();
          fechaFin.setMinutes(fechaFin.getMinutes() - minutosTotales);

          const nuevaHora = fechaFin.getHours().toString().padStart(2, '0');
          const nuevoMinuto = fechaFin.getMinutes().toString().padStart(2, '0');
          $horaInicioInput.val(`${nuevaHora}:${nuevoMinuto}`);

          calcularHorariosDesdeInicio();
        }

        function exportarDatos() {
          guardarEnLocal();
          let nombreArchivo = prompt('¿Cómo querés llamar al archivo?', 'actividades');
          if (nombreArchivo === null) {
            return;
          }
          nombreArchivo = nombreArchivo.trim();
          if (nombreArchivo === '') {
            nombreArchivo = 'actividades';
          }
          nombreArchivo = nombreArchivo.replace(/[\\/\?%\*:|"<>]/g, '-');
          if (!nombreArchivo.toLowerCase().endsWith('.json')) {
            nombreArchivo += '.json';
          }
          const datos = {
            horaInicio: $horaInicioInput.val(),
            horaFin: $horaFinInput.val(),
            actividades: []
          };
          $tablaActividades.find('tr').not('.fixed').each(function () {
            const nombre = $(this).find('.activity-name').text();
            const minutos = parseInt($(this).find('input[type="number"]').val(), 10) || 0;
            const inicio = $(this).find('td').eq(1).text();
            datos.actividades.push({ nombre, inicio, minutos });
          });
          const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
          const enlace = document.createElement('a');
          enlace.href = URL.createObjectURL(blob);
          enlace.download = nombreArchivo;
          enlace.click();
          URL.revokeObjectURL(enlace.href);
        }

        function importarArchivo(e) {
          const archivo = e.target.files[0];
          if (!archivo) return;
          const lector = new FileReader();
          lector.onload = function (ev) {
            try {
              const datos = JSON.parse(ev.target.result);
              if (Array.isArray(datos.actividades)) {
                localStorage.setItem('actividades', JSON.stringify(datos.actividades));
                if (datos.horaInicio) localStorage.setItem('horaInicio', datos.horaInicio);
                if (datos.horaFin) localStorage.setItem('horaFin', datos.horaFin);
                location.reload();
              } else {
                alert('El archivo no es válido.');
              }
            } catch {
              alert('El archivo no es válido.');
            }
          };
          lector.readAsText(archivo);
        }

        function reiniciarDatos() {
          if (confirm('¿Querés reiniciar la lista?')) {
            localStorage.clear();
            location.reload();
          }
        }

        function obtenerFechaPredeterminada() {
          const fechaBase = new Date();
          if (fechaBase.getHours() >= 22) {
            fechaBase.setDate(fechaBase.getDate() + 1);
          }
          const año = fechaBase.getFullYear();
          const mes = (fechaBase.getMonth() + 1).toString().padStart(2, '0');
          const dia = fechaBase.getDate().toString().padStart(2, '0');
          return `${año}-${mes}-${dia}`;
        }

        function abrirModalGoogleCalendar() {
          $fechaGoogle.val(obtenerFechaPredeterminada());
          $modalGoogle.fadeIn();
        }

        function cerrarModalGoogleCalendar() {
          $modalGoogle.fadeOut();
        }

        function formatearFechaICS(fecha) {
          return fecha.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        }

        function limpiarTextoICS(texto) {
          return texto
            .replace(/\\/g, '\\\\')
            .replace(/\n/g, '\\n')
            .replace(/,/g, '\\,')
            .replace(/;/g, '\\;');
        }

        function exportarAGoogleCalendar() {
          const fechaSeleccionada = $fechaGoogle.val();
          if (!fechaSeleccionada) {
            alert('Tenés que elegir una fecha.');
            return;
          }

          const zonaHoraria = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
          const marcaTiempo = formatearFechaICS(new Date());
          const separadorLinea = String.fromCharCode(13, 10);
          const lineasICS = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'CALSCALE:GREGORIAN',
            'PRODID:-//Planificador de Tiempo//ES',
            `X-WR-TIMEZONE:${zonaHoraria}`
          ];

          let cantidadEventos = 0;

          $tablaActividades.find('tr').not('.fixed').each(function (indice) {
            const nombreActividad = $(this).find('.activity-name').text().trim();
            const inicioTexto = $(this).find('td').eq(1).text().trim();
            const duracionMinutos = parseInt($(this).find('input[type="number"]').val(), 10);

            if (!nombreActividad || !inicioTexto || isNaN(duracionMinutos) || duracionMinutos <= 0) {
              return;
            }

            const partesHora = inicioTexto.split(':');
            if (partesHora.length < 2) {
              return;
            }

            const inicioActividad = new Date(`${fechaSeleccionada}T${partesHora[0].padStart(2, '0')}:${partesHora[1].padStart(2, '0')}:00`);
            if (isNaN(inicioActividad.getTime())) {
              return;
            }

            const finActividad = new Date(inicioActividad.getTime() + duracionMinutos * 60000);

            const identificador = `planificador-${fechaSeleccionada.replace(/-/g, '')}-${indice}-${Date.now()}@planificador-tiempo`;

            lineasICS.push('BEGIN:VEVENT');
            lineasICS.push(`UID:${identificador}`);
            lineasICS.push(`DTSTAMP:${marcaTiempo}`);
            lineasICS.push(`DTSTART:${formatearFechaICS(inicioActividad)}`);
            lineasICS.push(`DTEND:${formatearFechaICS(finActividad)}`);
            lineasICS.push(`SUMMARY:${limpiarTextoICS(nombreActividad)}`);
            lineasICS.push(`DESCRIPTION:${limpiarTextoICS('Duración estimada: ' + duracionMinutos + ' minutos')}`);
            lineasICS.push('END:VEVENT');

            cantidadEventos += 1;
          });

          if (cantidadEventos === 0) {
            alert('Necesitás tener actividades con horario y duración para exportar.');
            return;
          }

          lineasICS.push('END:VCALENDAR');

          const contenidoICS = lineasICS.join(separadorLinea) + separadorLinea;

          const blobCalendario = new Blob([contenidoICS], { type: 'text/calendar' });
          const enlaceDescarga = document.createElement('a');
          enlaceDescarga.href = URL.createObjectURL(blobCalendario);
          const nombreArchivo = `planificador-${fechaSeleccionada}.ics`;
          enlaceDescarga.download = nombreArchivo;
          enlaceDescarga.click();
          URL.revokeObjectURL(enlaceDescarga.href);

          cerrarModalGoogleCalendar();

          const ventanaImportacion = window.open('https://calendar.google.com/calendar/u/0/r/settings/import', '_blank');
          if (!ventanaImportacion) {
            alert('Descargamos un archivo .ics con tus actividades. Abrí Google Calendar y usá la opción Importar para subirlo.');
          } else {
            alert('Descargamos un archivo .ics con tus actividades. Importalo en Google Calendar desde la pestaña que se abrió.');
          }
        }

        $(document).on('input change blur focusout', '#activity-table input[type="number"]', function () {
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $horaInicioInput.on('input change blur focusout', function () {
          calcularHorariosDesdeInicio();
          guardarEnLocal();
        });

        $horaFinInput.on('input change blur focusout', function () {
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('blur', '.activity-name', function () {
          guardarEnLocal();
        });

        $(document).on('click', '.delete-btn', function () {
          const $filaActividad = $(this).closest('tr');
          $filaActividad.remove();
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('click', '.add-btn-inline', function () {
          const $filaActual = $(this).closest('tr');
          const nuevaFila = `
            <tr class="activity-row">
              <td class="activity-cell">
                <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                <div contenteditable="true" class="activity-name editable">Nueva Actividad</div>
                <button class="add-btn-inline">+</button>
              </td>
              <td></td>
              <td><input type="number" value="0"></td>
            </tr>`;
          $filaActual.after(nuevaFila);
          $filaActual.next().find('.activity-name').focus();
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('focus', '.activity-name', function () {
          const elemento = this;
          setTimeout(() => {
            const rango = document.createRange();
            rango.selectNodeContents(elemento);
            const seleccion = window.getSelection();
            seleccion.removeAllRanges();
            seleccion.addRange(rango);
          }, 0);
        });

        $(document).on('focus', 'input[type="number"]', function () {
          this.select();
        });

        $botonExportar.on('click', exportarDatos);
        $botonExportarGoogle.on('click', abrirModalGoogleCalendar);
        $botonImportar.on('click', () => $archivoImportar.click());
        $archivoImportar.on('change', importarArchivo);
        $botonReiniciar.on('click', reiniciarDatos);
        $cerrarModalGoogle.on('click', cerrarModalGoogleCalendar);
        $cancelarExportacionGoogle.on('click', function () {
          cerrarModalGoogleCalendar();
        });
        $confirmarExportacionGoogle.on('click', exportarAGoogleCalendar);

        renderizarActividades(cargarDesdeLocal());
        establecerTiemposIniciales();

        $('#start-time').flatpickr({
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          onChange: function () {
            calcularHorariosDesdeInicio();
            guardarEnLocal();
          }
        });

        $('#end-time').flatpickr({
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          onChange: function () {
            calcularInicioDesdeFin();
            guardarEnLocal();
          }
        });
      });
    </script>
  <button id="to-top" class="to-top" aria-label="Volver arriba">&#8679;</button>
  <script src="scripts.js"></script>
</body>
</html>
