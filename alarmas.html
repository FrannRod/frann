<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planificador de Tiempo</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script async defer src="https://apis.google.com/js/api.js"></script>
  <!-- Font Awesome para los iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@300&display=swap">
  <style>

    .content-section {
      max-width: 100%;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background-color: #ffffff;
      table-layout: auto;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      word-wrap: break-word;
      position: relative;
    }

    table th {
      background-color: #e9ecef;
      font-size: 1.2em;
      font-weight: bold;
    }

    .editable {
      background-color: #ffffe0;
      cursor: pointer;
    }

    .delete-btn {
      background-color: transparent;
      color: #ff5c5c;
      border: none;
      padding: 10px;
      cursor: pointer;
      transition: color 0.3s, transform 0.3s;
      font-size: 1.2em;
      margin-right: 8px;
    }

    .delete-btn:hover {
      color: #e04e4e;
      transform: scale(1.2);
    }

    .activity-cell {
      position: relative;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .add-btn-inline {
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.05);
      color: #4CAF50;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5em;
      line-height: 30px;
      text-align: center;
      opacity: 0.7;
      transition: background-color 0.3s, opacity 0.3s;
    }

    .add-btn-inline:hover {
      background-color: rgba(0, 0, 0, 0.1);
      opacity: 1;
    }

    .form-group {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
    }
      .controles-archivo {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }


    /* Modal styles for help section */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
    }

    .modal-content h3 {
      text-align: center;
    }

    #fecha-google-calendar {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-top: 15px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .acciones-modal {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
    }

    @media (max-width: 768px) {
      header {
        padding: 10px;
      }

      input[type="number"] {
        width: 50px;
      }

      h1 {
        font-size: 2em;
      }

      table th, table td {
        font-size: 0.8em;
        padding: 6px;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .content-section {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="header-content">
      <h1>Planificador de Tiempo</h1>
      <nav class="nav-links">
        <a href="index.html">Volver</a>
      </nav>
    </div>
    <a href="#planner" class="scroll-down" aria-label="Desplazar hacia el contenido">
      <i class="fas fa-chevron-down"></i>
    </a>
  </header>

  <main>
    <section id="planner" class="content-section">
      <h2>Configuración de Actividades <button id="help-button" class="button small">?</button></h2>
        <div class="controles-archivo">
          <button id="boton-exportar" class="button small">Exportar</button>
          <button id="boton-exportar-google" class="button small">Exportar a Google Calendar</button>
          <button id="boton-importar" class="button small">Importar</button>
          <input type="file" id="archivo-importar" accept="application/json" style="display:none">
          <button id="boton-reiniciar" class="button small">Reiniciar</button>
        </div>


      <div style="overflow-x: auto;">
        <table id="activity-table">
          <thead>
            <tr>
              <th>Actividad</th>
              <th>Inicio</th>
              <th>Duración (min)</th>
            </tr>
          </thead>
          <tbody>
              <tr class="fixed">
                <td>Hora de inicio
                <button class="add-btn-inline">+</button></td>
                <td><input type="time" id="start-time"></td>
                <td>-</td>
              </tr>
              <tr class="fixed">
                <td>Hora de fin</td>
                <td><input type="time" id="end-time" ></td>
                <td>-</td>
              </tr>
          </tbody>
        </table>
      </div>
      <div class="form-group">
        <label for="total-duration">Duración total:</label>
        <span id="total-duration">00:00</span>
      </div>
    </section>

    <!-- Modal with help content -->
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <span id="close-help" class="close">&times;</span>
        <h3>¿Cómo usar?</h3>
        <p style="text-align: justify; font-size: 1em; line-height: 1.5;">
          Esta herramienta está pensada para maximizar tus horas de sueño y organizar tus mañanas de forma eficiente. Seleccioná las actividades que hacés habitualmente por la mañana y asignales el tiempo (aproximado) que te llevan, como se ve en los ejemplos. Podés agregar nuevas actividades, o eliminar las existentes tocando el ícono del tachito. Luego, configurá la hora a la que querés terminar todo, y automáticamente se calculará la hora de inicio. Esto te va a ayudar a saber a qué hora programar tus alarmas para optimizar tu descanso. También podés fijar la hora de inicio y la herramienta calculará a qué hora vas a terminar con todo.
        </p>
      </div>
    </div>
    <div id="modal-google-calendar" class="modal">
      <div class="modal-content">
        <span id="cerrar-google-calendar" class="close">&times;</span>
        <h3>Exportar a Google Calendar</h3>
        <p style="text-align: justify; font-size: 1em; line-height: 1.5;">
          Elegí la fecha desde la que querés agendar estas actividades. Vamos a respetar tus horarios y tu zona horaria
          automáticamente.
        </p>
        <input type="date" id="fecha-google-calendar">
        <div class="acciones-modal">
          <button id="confirmar-google-calendar" class="button small">Exportar</button>
          <button id="cancelar-google-calendar" class="button small">Cancelar</button>
        </div>
      </div>
    </div>
  </main>

    <script>
      $(document).ready(function () {
        const $horaInicioInput = $('#start-time');
        const $horaFinInput = $('#end-time');
        const $duracionTotalEtiqueta = $('#total-duration');
        const $tablaActividades = $('#activity-table tbody');
        const $modalAyuda = $('#help-modal');
        const $botonAyuda = $('#help-button');
        const $cerrarAyuda = $('#close-help');
        const $botonExportar = $('#boton-exportar');
        const $botonExportarGoogle = $('#boton-exportar-google');
        const $botonImportar = $('#boton-importar');
        const $archivoImportar = $('#archivo-importar');
        const $botonReiniciar = $('#boton-reiniciar');
        const $modalGoogleCalendar = $('#modal-google-calendar');
        const $cerrarGoogleCalendar = $('#cerrar-google-calendar');
        const $fechaGoogleCalendar = $('#fecha-google-calendar');
        const $confirmarGoogleCalendar = $('#confirmar-google-calendar');
        const $cancelarGoogleCalendar = $('#cancelar-google-calendar');
        let googleClientId = localStorage.getItem('googleClientId') || '';
        let clienteGoogleInicializado = false;
        const zonaHorariaLocal = Intl.DateTimeFormat().resolvedOptions().timeZone;

        $botonAyuda.on('click', function () {
          $modalAyuda.fadeIn();
        });

        $cerrarAyuda.on('click', function () {
          $modalAyuda.fadeOut();
        });

        $(window).on('click', function (e) {
          if ($(e.target).is($modalAyuda)) {
            $modalAyuda.fadeOut();
          }
          if ($(e.target).is($modalGoogleCalendar)) {
            $modalGoogleCalendar.fadeOut();
          }
        });

        function guardarEnLocal() {
          const actividades = [];
          $tablaActividades.find('tr').not('.fixed').each(function () {
            const nombre = $(this).find('.activity-name').text();
            const minutos = parseInt($(this).find('input[type="number"]').val(), 10) || 0;
            actividades.push({ nombre, minutos });
          });
          localStorage.setItem('actividades', JSON.stringify(actividades));
          localStorage.setItem('horaInicio', $horaInicioInput.val());
          localStorage.setItem('horaFin', $horaFinInput.val());
        }

        function cargarDesdeLocal() {
          const guardado = localStorage.getItem('actividades');
          if (guardado) {
            return JSON.parse(guardado);
          }
          const ejemplo = [
            { nombre: 'Alarma', minutos: 2 },
            { nombre: 'Bañarse', minutos: 30 },
            { nombre: 'Cambiarse', minutos: 15 },
            { nombre: 'Viaje', minutos: 30 }
          ];
          localStorage.setItem('actividades', JSON.stringify(ejemplo));
          localStorage.setItem('horaInicio', '07:00');
          localStorage.setItem('horaFin', '08:17');
          return ejemplo;
        }

        function renderizarActividades(lista) {
          const $filaFin = $tablaActividades.find('tr').last();
          lista.forEach(act => {
            const fila = `
            <tr class="activity-row">
              <td class="activity-cell">
                <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                <div contenteditable="true" class="activity-name editable">${act.nombre}</div>
                <button class="add-btn-inline">+</button>
              </td>
              <td></td>
              <td><input type="number" value="${act.minutos}"></td>
            </tr>`;
            $filaFin.before(fila);
          });
        }

        function establecerTiemposIniciales() {
          const inicioGuardado = localStorage.getItem('horaInicio') || '07:00';
          const finGuardado = localStorage.getItem('horaFin') || '08:17';
          $horaInicioInput.val(inicioGuardado);
          $horaFinInput.val(finGuardado);
          calcularInicioDesdeFin();
        }

        function calcularDuracionTotal() {
          let minutosTotales = 0;
          $tablaActividades.find('tr').not('.fixed').find('input[type="number"]').each(function () {
            const valor = parseInt($(this).val(), 10);
            if (!isNaN(valor)) {
              minutosTotales += valor;
            }
          });
          const horas = Math.floor(minutosTotales / 60);
          const minutos = minutosTotales % 60;
          $duracionTotalEtiqueta.text(`${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`);
          return minutosTotales;
        }

        function calcularHorariosDesdeInicio() {
          const inicio = $horaInicioInput.val().split(':');
          let hora = parseInt(inicio[0], 10);
          let minuto = parseInt(inicio[1], 10);
          let horaActual = new Date(0, 0, 0, hora, minuto, 0);

          $tablaActividades.find('tr').not('.fixed').each(function () {
            const $inicioActividad = $(this).find('td').eq(1);
            const duracion = parseInt($(this).find('input[type="number"]').val(), 10);
            if (!isNaN(duracion)) {
              $inicioActividad.text(horaActual.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
              horaActual.setMinutes(horaActual.getMinutes() + duracion);
            } else {
              $inicioActividad.text('NaN');
            }
          });

          $horaFinInput.val(horaActual.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
        }

        function calcularInicioDesdeFin() {
          const fin = $horaFinInput.val().split(':');
          let hora = parseInt(fin[0], 10);
          let minuto = parseInt(fin[1], 10);
          let fechaFin = new Date(0, 0, 0, hora, minuto, 0);

          const minutosTotales = calcularDuracionTotal();
          fechaFin.setMinutes(fechaFin.getMinutes() - minutosTotales);

          const nuevaHora = fechaFin.getHours().toString().padStart(2, '0');
          const nuevoMinuto = fechaFin.getMinutes().toString().padStart(2, '0');
          $horaInicioInput.val(`${nuevaHora}:${nuevoMinuto}`);

          calcularHorariosDesdeInicio();
        }

        function exportarDatos() {
          guardarEnLocal();
          const nombreDefecto = 'actividades.json';
          let nombreArchivo = prompt('¿Cómo querés llamar al archivo exportado?', nombreDefecto);
          if (nombreArchivo === null) {
            return;
          }
          nombreArchivo = nombreArchivo.trim();
          if (nombreArchivo === '') {
            nombreArchivo = nombreDefecto;
          }
          if (!nombreArchivo.toLowerCase().endsWith('.json')) {
            nombreArchivo += '.json';
          }
          nombreArchivo = nombreArchivo.replace(/\s+/g, '_');
          const datos = {
            horaInicio: $horaInicioInput.val(),
            horaFin: $horaFinInput.val(),
            actividades: []
          };
          $tablaActividades.find('tr').not('.fixed').each(function () {
            const nombre = $(this).find('.activity-name').text();
            const minutos = parseInt($(this).find('input[type="number"]').val(), 10) || 0;
            const inicio = $(this).find('td').eq(1).text();
            datos.actividades.push({ nombre, inicio, minutos });
          });
          const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
          const enlace = document.createElement('a');
          enlace.href = URL.createObjectURL(blob);
          enlace.download = nombreArchivo;
          enlace.click();
          URL.revokeObjectURL(enlace.href);
        }

        function importarArchivo(e) {
          const archivo = e.target.files[0];
          if (!archivo) return;
          const lector = new FileReader();
          lector.onload = function (ev) {
            try {
              const datos = JSON.parse(ev.target.result);
              if (Array.isArray(datos.actividades)) {
                localStorage.setItem('actividades', JSON.stringify(datos.actividades));
                if (datos.horaInicio) localStorage.setItem('horaInicio', datos.horaInicio);
                if (datos.horaFin) localStorage.setItem('horaFin', datos.horaFin);
                location.reload();
              } else {
                alert('El archivo no es válido.');
              }
            } catch {
              alert('El archivo no es válido.');
            }
          };
          lector.readAsText(archivo);
        }

        function reiniciarDatos() {
          if (confirm('¿Querés reiniciar la lista?')) {
            localStorage.clear();
            location.reload();
          }
        }

        function obtenerFechaBasePorDefecto() {
          const ahora = new Date();
          if (ahora.getHours() >= 22) {
            ahora.setDate(ahora.getDate() + 1);
          }
          const anio = ahora.getFullYear();
          const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
          const dia = ahora.getDate().toString().padStart(2, '0');
          return `${anio}-${mes}-${dia}`;
        }

        function combinarFechaYHora(fechaIso, horaTexto) {
          if (!fechaIso || !horaTexto) {
            return null;
          }
          const partesFecha = fechaIso.split('-');
          const partesHora = horaTexto.split(':');
          if (partesFecha.length < 3 || partesHora.length < 2) {
            return null;
          }
          const anio = parseInt(partesFecha[0], 10);
          const mes = parseInt(partesFecha[1], 10) - 1;
          const dia = parseInt(partesFecha[2], 10);
          const hora = parseInt(partesHora[0], 10);
          const minuto = parseInt(partesHora[1], 10);
          if ([anio, mes, dia, hora, minuto].some(valor => Number.isNaN(valor))) {
            return null;
          }
          return new Date(anio, mes, dia, hora, minuto, 0);
        }

        function formatearFechaParaGoogle(fecha) {
          const anio = fecha.getFullYear();
          const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
          const dia = fecha.getDate().toString().padStart(2, '0');
          const horas = fecha.getHours().toString().padStart(2, '0');
          const minutos = fecha.getMinutes().toString().padStart(2, '0');
          const segundos = fecha.getSeconds().toString().padStart(2, '0');
          const offset = -fecha.getTimezoneOffset();
          const signo = offset >= 0 ? '+' : '-';
          const horasOffset = Math.floor(Math.abs(offset) / 60).toString().padStart(2, '0');
          const minutosOffset = (Math.abs(offset) % 60).toString().padStart(2, '0');
          return `${anio}-${mes}-${dia}T${horas}:${minutos}:${segundos}${signo}${horasOffset}:${minutosOffset}`;
        }

        function construirEventosParaGoogle(fechaBase) {
          calcularHorariosDesdeInicio();
          const eventos = [];
          $tablaActividades.find('tr').not('.fixed').each(function () {
            const nombreActividad = $(this).find('.activity-name').text().trim();
            const minutos = parseInt($(this).find('input[type="number"]').val(), 10);
            const inicioTexto = $(this).find('td').eq(1).text().trim();
            if (!nombreActividad || Number.isNaN(minutos) || minutos <= 0 || !inicioTexto) {
              return;
            }
            const inicio = combinarFechaYHora(fechaBase, inicioTexto);
            if (!inicio) {
              return;
            }
            const fin = new Date(inicio.getTime() + minutos * 60000);
            eventos.push({
              summary: nombreActividad,
              start: {
                dateTime: formatearFechaParaGoogle(inicio),
                timeZone: zonaHorariaLocal
              },
              end: {
                dateTime: formatearFechaParaGoogle(fin),
                timeZone: zonaHorariaLocal
              },
              description: 'Generado automáticamente desde el Planificador de Tiempo'
            });
          });
          return eventos;
        }

        function solicitarClientIdSiHaceFalta() {
          if (googleClientId) {
            return true;
          }
          const ingreso = prompt('Necesitamos el Client ID OAuth 2.0 de Google para conectarnos con tu calendario. Pegalo acá (formato xxxxx.apps.googleusercontent.com):');
          if (ingreso && ingreso.trim()) {
            googleClientId = ingreso.trim();
            localStorage.setItem('googleClientId', googleClientId);
            return true;
          }
          return false;
        }

        function inicializarClienteGoogle() {
          return new Promise((resolve, reject) => {
            if (clienteGoogleInicializado) {
              resolve(gapi.auth2.getAuthInstance());
              return;
            }
            if (typeof gapi === 'undefined') {
              reject(new Error('La librería de Google no se cargó correctamente.'));
              return;
            }
            gapi.load('client:auth2', async () => {
              try {
                await gapi.client.init({
                  clientId: googleClientId,
                  scope: 'https://www.googleapis.com/auth/calendar.events',
                  discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                });
                clienteGoogleInicializado = true;
                resolve(gapi.auth2.getAuthInstance());
              } catch (error) {
                reject(error);
              }
            });
          });
        }

        async function exportarActividadesAGoogleCalendar(fechaBase) {
          try {
            if (!solicitarClientIdSiHaceFalta()) {
              alert('Necesitás configurar el Client ID de Google para poder exportar.');
              return;
            }
            const eventos = construirEventosParaGoogle(fechaBase);
            if (!eventos.length) {
              alert('No hay actividades con duración válida para exportar.');
              return;
            }
            const instanciaAuth = await inicializarClienteGoogle();
            if (!instanciaAuth.isSignedIn.get()) {
              await instanciaAuth.signIn();
            }
            for (const evento of eventos) {
              await gapi.client.calendar.events.insert({
                calendarId: 'primary',
                resource: evento
              });
            }
            alert('Las actividades se exportaron a tu Google Calendar.');
          } catch (error) {
            console.error('Error al exportar a Google Calendar:', error);
            let mensajeError = null;
            if (error && error.result && error.result.error && error.result.error.message) {
              mensajeError = error.result.error.message;
            } else if (error && error.message) {
              mensajeError = error.message;
            }
            if (mensajeError) {
              alert(`No se pudo exportar a Google Calendar: ${mensajeError}`);
            } else {
              alert('No se pudo exportar a Google Calendar. Revisá la consola para más detalles.');
            }
          }
        }

        $botonExportarGoogle.on('click', function () {
          $fechaGoogleCalendar.val(obtenerFechaBasePorDefecto());
          $modalGoogleCalendar.fadeIn();
        });

        $cerrarGoogleCalendar.on('click', function () {
          $modalGoogleCalendar.fadeOut();
        });

        $cancelarGoogleCalendar.on('click', function () {
          $modalGoogleCalendar.fadeOut();
        });

        $confirmarGoogleCalendar.on('click', async function () {
          const fechaSeleccionada = $fechaGoogleCalendar.val();
          if (!fechaSeleccionada) {
            alert('Seleccioná una fecha para exportar.');
            return;
          }
          $modalGoogleCalendar.fadeOut();
          await exportarActividadesAGoogleCalendar(fechaSeleccionada);
        });

        $(document).on('input change blur focusout', '#activity-table input[type="number"]', function () {
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $horaInicioInput.on('input change blur focusout', function () {
          calcularHorariosDesdeInicio();
          guardarEnLocal();
        });

        $horaFinInput.on('input change blur focusout', function () {
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('blur', '.activity-name', function () {
          guardarEnLocal();
        });

        $(document).on('click', '.delete-btn', function () {
          const $filaActividad = $(this).closest('tr');
          $filaActividad.remove();
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('click', '.add-btn-inline', function () {
          const $filaActual = $(this).closest('tr');
          const nuevaFila = `
            <tr class="activity-row">
              <td class="activity-cell">
                <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                <div contenteditable="true" class="activity-name editable">Nueva Actividad</div>
                <button class="add-btn-inline">+</button>
              </td>
              <td></td>
              <td><input type="number" value="0"></td>
            </tr>`;
          $filaActual.after(nuevaFila);
          $filaActual.next().find('.activity-name').focus();
          calcularInicioDesdeFin();
          guardarEnLocal();
        });

        $(document).on('focus', '.activity-name', function () {
          const elemento = this;
          setTimeout(() => {
            const rango = document.createRange();
            rango.selectNodeContents(elemento);
            const seleccion = window.getSelection();
            seleccion.removeAllRanges();
            seleccion.addRange(rango);
          }, 0);
        });

        $(document).on('focus', 'input[type="number"]', function () {
          this.select();
        });

        $botonExportar.on('click', exportarDatos);
        $botonImportar.on('click', () => $archivoImportar.click());
        $archivoImportar.on('change', importarArchivo);
        $botonReiniciar.on('click', reiniciarDatos);

        renderizarActividades(cargarDesdeLocal());
        establecerTiemposIniciales();

        $('#start-time').flatpickr({
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          onChange: function () {
            calcularHorariosDesdeInicio();
            guardarEnLocal();
          }
        });

        $('#end-time').flatpickr({
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i",
          onChange: function () {
            calcularInicioDesdeFin();
            guardarEnLocal();
          }
        });
      });
    </script>
  <button id="to-top" class="to-top" aria-label="Volver arriba">&#8679;</button>
  <script src="scripts.js"></script>
</body>
</html>
